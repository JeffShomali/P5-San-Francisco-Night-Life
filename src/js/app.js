"use strict";

/**
 * [locations description]
 * @type {Array}
 */
var locations = [{
    id: "45ac12d6f964a5205d411fe3",
    name: "Saga Night Club",
    formattedPhone: "(415) 882-4435",
    address: "750 Harrison St, San Francisco, CA, 94107",
    lat: 37.7817,
    lng: -122.399002,
    url: 'www.example.com',
    filter: ['Night Club', 'Night Life', 'Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "El Toro Night Club",
    formattedPhone: "(415) 468-0670",
    address: "2470 San Bruno Ave, San Francisco, CA, 94134",
    lat: 37.73076295852661,
    lng: -122.404949,
    url: 'www.example.com',
    filter: ['Night Club', 'Night Life', 'Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Temple Night Club",
    formattedPhone: "(415) 882-4435",
    address: "540 Howard St, San Francisco, CA, 94105",
    lat: 37.81815270099963,
    lng: -122.34477495801933,
    url: 'www.example.com',
    filter: ['Night Club', 'Night Life', 'Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Study all night Club",
    formattedPhone: "(415) 882-4435",
    address: "San Francisco, CA,94105",
    lat: 37.721531,
    lng: -122.459652,
    url: 'www.example.com',
    filter: ['Night Club', 'Night Life', 'Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Wayo Sushi",
    formattedPhone: "(415) 474-8369",
    address: "1407 Van Ness Ave, San Francisco, CA, 94109",
    lat: 37.7886,
    lng: -122.421868,
    url: "http://sushiboat-hub.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Nara Sushi",
    formattedPhone: "(415) 567-1515",
    address: "1515 Polk St, San Francisco, CA, 94109",
    lat: 37.790912,
    lng: -122.42078,
    url: "http://sushiboat-hub.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Sushi Boat",
    formattedPhone: "(415) 781-5111",
    address: "389 Geary St, San Francisco, CA, 94102",
    lat: 37.78716444969067,
    lng: -122.409693,
    url: "http://sushiboat-hub.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Sakana Sushi & Grill",
    formattedPhone: "(415) 775-7644",
    address: "605 Post St, San Francisco, CA, 94109",
    lat: 37.787843977022874,
    lng: -122.41172790527344,
    url: "http://sfsakana.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Maru Sushi",
    formattedPhone: "(415) 393-9911",
    address: "529 Powell St, San Francisco, CA, 94108",
    lat: 37.78960361061905,
    lng: -122.40871786760785,
    url: "http://sushiboat-hub.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Akikoâ€™s Restaurant & Sushi Bar",
    formattedPhone: "(415) 397-3218",
    address: "431 Bush St, San Francisco, CA, 94108",
    lat: 37.7905592751754,
    lng: -122.4046978354454,
    url: "http://akikosrestaurant.com",
    filter: ['sushi', 'food', 'bar']

}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Okoze Sushi",
    formattedPhone: "(415) 567-3397",
    address: "1207 Union St, San Francisco, CA, 94109",
    lat: 37.79913516819813,
    lng: -122.41938691474148,
    url: "http://sushiboat-hub.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Sudachi Sushi & Korean BBQ",
    formattedPhone: "(415) 931-6951",
    address: "1217 Sutter St, San Francisco, CA, 94109",
    lat: 37.7875653,
    lng: -122.420459,
    url: "http://sudachisf.net",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Live Sushi Bar",
    formattedPhone: "(415) 861-8610",
    address: "2001 17th St, San Francisco, CA, 94103",
    lat: 37.76467,
    lng: -122.40351304,
    url: "http://www.livesushibar.com/",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Elephant Sushi",
    formattedPhone: "(415) 359-9001",
    address: "380 Golden Gate Ave, San Francisco, CA, 94102",
    lat: 37.78153661500664,
    lng: -122.4169313047121,
    url: "http://elephantsushi.com",
    filter: ['sushi', 'food', 'bar']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Oaktown 8s Square Dance club",
    formattedPhone: "(415) 633-3900",
    address: "747 Market St, Oakland, CA, 94109",
    postalCode: "",
    lat: 37.81148696748271,
    lng: -122.26081093886104,
    url: "http://www.SmallFryDanceClub.com",
    filter: ['Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Equinox Sports Club San Francisco",
    formattedPhone: "(415) 633-3900",
    address: "747 Market St, San Francisco, CA, 94103",
    lat: 37.786451314671154,
    lng: -122.40423113107681,
    url: "http://www.facebook.com/equinox",
    filter: ['Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Liholiho Yacht Club",
    formattedPhone: "(415) 440-5446",
    address: "871 Sutter St, San Francisco, CA, 94109",
    lat: 37.78836869881094,
    lng: -122.4145862541547,
    url: "http://liholihoyachtclub.com",
    filter: ['Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Napa Dance Club",
    formattedPhone: "(415) 633-3900",
    address: "747 Market St, Redwood City, CA, 94062",
    lat: 37.489222,
    lng: -122.239173,
    url: "http://www.SmallFryDanceClub.com",
    filter: ['Dance']
}, {
    id: "45ac12d6f964a5205d411fe3",
    name: "Small Fry Dance Club",
    formattedPhone: "(650) 393-5593",
    address: "1528 S El Camino Real Ste 208, San Mateo, CA, 94402 ",
    postalCode: "",
    lat: 37.55348327633724,
    lng: -122.3159408569336,
    url: "http://www.SmallFryDanceClub.com",
    filter: ['Dance']
}];


//Night Mode Style
/**
 * [styleArray description]
 * @type {Array}
 */
var styleArray = [{
    "featureType": "all",
    "elementType": "labels",
    "stylers": [{
        "visibility": "on"
    }]
}, {
    "featureType": "all",
    "elementType": "labels.text.fill",
    "stylers": [{
        "saturation": 36
    }, {
        "color": "#000000"
    }, {
        "lightness": 40
    }]
}, {
    "featureType": "all",
    "elementType": "labels.text.stroke",
    "stylers": [{
        "visibility": "on"
    }, {
        "color": "#000000"
    }, {
        "lightness": 16
    }]
}, {
    "featureType": "all",
    "elementType": "labels.icon",
    "stylers": [{
        "visibility": "off"
    }]
}, {
    "featureType": "administrative",
    "elementType": "geometry.fill",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 20
    }]
}, {
    "featureType": "administrative",
    "elementType": "geometry.stroke",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 17
    }, {
        "weight": 1.2
    }]
}, {
    "featureType": "administrative.country",
    "elementType": "labels.text.fill",
    "stylers": [{
        "color": "#ed5929"
    }]
}, {
    "featureType": "administrative.locality",
    "elementType": "labels.text.fill",
    "stylers": [{
        "color": "#c4c4c4"
    }]
}, {
    "featureType": "administrative.neighborhood",
    "elementType": "labels.text.fill",
    "stylers": [{
        "color": "#ed5929"
    }]
}, {
    "featureType": "landscape",
    "elementType": "geometry",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 20
    }]
}, {
    "featureType": "poi",
    "elementType": "geometry",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 21
    }, {
        "visibility": "on"
    }]
}, {
    "featureType": "poi.business",
    "elementType": "geometry",
    "stylers": [{
        "visibility": "on"
    }]
}, {
    "featureType": "road.highway",
    "elementType": "geometry.fill",
    "stylers": [{
        "color": "#ed5929"
    }, {
        "lightness": "0"
    }]
}, {
    "featureType": "road.highway",
    "elementType": "geometry.stroke",
    "stylers": [{
        "visibility": "off"
    }]
}, {
    "featureType": "road.highway",
    "elementType": "labels.text.fill",
    "stylers": [{
        "color": "#ffffff"
    }]
}, {
    "featureType": "road.highway",
    "elementType": "labels.text.stroke",
    "stylers": [{
        "color": "#ed5929"
    }]
}, {
    "featureType": "road.arterial",
    "elementType": "geometry",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 18
    }]
}, {
    "featureType": "road.arterial",
    "elementType": "geometry.fill",
    "stylers": [{
        "color": "#575757"
    }]
}, {
    "featureType": "road.arterial",
    "elementType": "labels.text.fill",
    "stylers": [{
        "color": "#ffffff"
    }]
}, {
    "featureType": "road.arterial",
    "elementType": "labels.text.stroke",
    "stylers": [{
        "color": "#2c2c2c"
    }]
}, {
    "featureType": "road.local",
    "elementType": "geometry",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 16
    }]
}, {
    "featureType": "road.local",
    "elementType": "labels.text.fill",
    "stylers": [{
        "color": "#999999"
    }]
}, {
    "featureType": "transit",
    "elementType": "geometry",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 19
    }]
}, {
    "featureType": "water",
    "elementType": "geometry",
    "stylers": [{
        "color": "#000000"
    }, {
        "lightness": 17
    }]
}];

/**
 * [fourSquareAPI description]
 * @type {Object}
 */
var fourSquareAPI = {
    "client_id": "ITE0R1YK5FQLKGDOZSBEPT1NK1WOJNMXI2MF23UZK4CFJV1Q",
    "client_secret": "TETG0XTAT4LTIYCXOFUGXYCCOU4ZMOMI4X4BGEJGZMLNJPCQ",
};

/**
 * [googleMapObject description]
 * @type {Object}
 */
var googleMapObject = {
    map: {},
    options: {
        center: {
            lat: 37.7886,
            lng: -122.4218
        },
        zoom: 13,
        mapTypeControl: false,
        styles: styleArray
    },

    /**
     * [InfoWindow description]
     */
    largeInfoWindow: new google.maps.InfoWindow(),
    infoWindowContent: '<div class="info-window"><div class="window-title"> <h4> %name% </h4> </div><div class="window-address"> %address% </div> <p>%phone%</p> </div><br> <p><a href="%weburl%">Website</a></p></div>',
    /**
     * [function description]
     * @param  {[type]} viewM [description]
     * @return {[type]}       [description]
     */
    initMap: function(viewM) {

        googleMapObject.map = new google.maps.Map(document.getElementById('map'), googleMapObject.options);
        if (viewM.initialized && !viewM.hasMarkers) viewM.showMarkers();
    }
};

/**
 * [function description]
 * @param  {[type]} data   [description]
 * @param  {[type]} parent [description]
 * @return {[type]}        [description]
 */
var Location = function(data, parent) {
    this.name = ko.observable(data.name);
    this.address = ko.observable(data.address);
    this.lat = ko.observable(data.lat);
    this.lng = ko.observable(data.lng);
    this.filter = ko.observableArray(data.filter);
    /**
     * [observable description]
     * @param  {[type]} false [description]
     * @return {[type]}       [description]
     */
    this.initialized = ko.observable(false);

    this.photo = ko.observable(); // for holding photo

    /**
     * [Marker description]
     * @param {[type]} position [description]
     */
    var marker = new google.maps.Marker({
        position: new google.maps.LatLng(data.lat, data.lng),
        icon: 'images/marker.png'
    });

    /**
     * [addListener description]
     * @param {[type]} marker   [description]
     * @param {[type]} click    [description]
     * @param {[type]} function [description]
     */
    google.maps.event.addListener(marker, 'click', (function(place, parent) {
        return function() {
            parent.displayGeoandMarker(place);
        };
    })(this, parent));
    this.marker = marker;
};


/**
 * [function description]
 * @param  {[type]} data [description]
 * @return {[type]}      [description]
 */
var Filter = function(data) {
    this.name = ko.observable(data.name);
    this.on = ko.observable(true);
};

/**
 * [function description]
 * @return {[type]} [description]
 */
var ViewModel = function() {
    var self = this;

    self.filter = ko.observable('');
    self.place = ko.observable();
    self.initialized = false;
    self.hasMarkers = false;
    self.connectionError = ko.observable(false);
    /**
     * [function description]
     * @return {[type]} [description]
     */
    self.init = function() {
        var tempTagArr = [];
        var tempFilterArr = [];


        self.placeList = ko.observableArray([]);

        /**
         *
         */
        locations.forEach(function(place) {
            self.placeList.push(new Location(place, self));


            place.filter.forEach(function(tag) {
                if (tempTagArr.indexOf(tag) < 0) {
                    tempTagArr.push(tag);
                }
            });
        });

        /**
         * [forEach description]
         * @param  {[type]} function [description]
         * @return {[type]}          [description]
         */
        tempTagArr.forEach(function(tag) {
            tempFilterArr.push(new Filter({
                name: tag
            }));
        });

        /**
         * [observableArray description]
         * @param  {[type]} tempFilterArr [description]
         * @return {[type]}               [description]
         */
        self.filters = ko.observableArray(tempFilterArr);

        /**
         * [computed description]
         * @param  {[type]} function [description]
         * @return {[type]}          [description]
         */
        self.currentFilters = ko.computed(function() {
            var tempCurrentFilters = [];


            ko.utils.arrayForEach(self.filters(), function(filter) {
                if (filter.on()) tempCurrentFilters.push(filter.name());
            });

            return tempCurrentFilters;
        });

        /**
         * [computed description]
         * @param  {[type]} function [description]
         * @return {[type]}          [description]
         */
        self.filteredPlaces = ko.computed(function() {
            var tempPlaces = ko.observableArray([]);
            var returnPlaces = ko.observableArray([]);


            ko.utils.arrayForEach(self.placeList(), function(place) {
                var placeTags = place.filter();


                var intersections = placeTags.filter(function(tag) {
                    return self.currentFilters().indexOf(tag) != -1;
                });


                if (intersections.length > 0) tempPlaces.push(place);
            });

            var tempSearchFilter = self.filter().toLowerCase();


            if (!tempSearchFilter) {
                returnPlaces = tempPlaces();
            } else {
                returnPlaces = ko.utils.arrayFilter(tempPlaces(), function(place) {
                    return place.name().toLowerCase().indexOf(tempSearchFilter) !== -1;
                });
            }


            self.filterMarkers(returnPlaces);
            return returnPlaces;

        });

        /**
         * [if description]
         * @param  {[type]} self [description]
         * @return {[type]}      [description]
         */
        if (!self.hasMarkers) self.showMarkers();
        self.initialized = true;
    };


    self.filterMarkers = function(filteredPlaces) {
        ko.utils.arrayForEach(self.placeList(), function(place) {
            if (filteredPlaces.indexOf(place) === -1) {
                place.marker.setVisible(false);
            } else {
                place.marker.setVisible(true);
            }
        });
    };


    self.toggleFilter = function(filter) {
        filter.on(!filter.on());
    };


    self.displayGeoandMarker = function(loc) {

        if (self.place()) self.place().marker.setIcon('images/marker.png');
        loc.marker.setIcon('images/selected.png');

        self.connectionError(false);
        if (!loc.initialized()) {

            $.ajax({
                    url: 'https://api.foursquare.com/v2/venues/search?ll=' + loc.lat() + ',' + loc.lng() + '&intent=match&name=' + loc.name() + '&client_id=' + fourSquareAPI.client_id + '&client_secret=' + fourSquareAPI.client_secret + '&v=20150326'
                })
                .done(function(data) {
                    var venue = data.response.venues[0];

                    loc.id = ko.observable(venue.id);

                    if (venue.hasOwnProperty('url')) {
                        loc.url = ko.observable(venue.url);
                    }
                    if (venue.hasOwnProperty('contact') && venue.contact.hasOwnProperty('formattedPhone')) {
                        loc.phone = ko.observable(venue.contact.formattedPhone);
                    }

                    //Populate infoWindows
                    /**
                     * [setContent description]
                     * @param {[type]} googleMapObject [description]
                     */
                    googleMapObject.largeInfoWindow.setContent(googleMapObject.infoWindowContent.replace('%name%', loc.name()).replace('%address%', loc.address()).replace('%phone%', loc.phone()).replace('%weburl%', loc.url()));
                    googleMapObject.largeInfoWindow.open(googleMapObject.map, loc.marker);


                })
                .fail(function(err) {

                    self.connectionError(true);
                    self.scrollTo('#location-call-back-wrapper');
                });
        }
    };

    /**
     * [function description]
     * @param  {[type]} el [description]
     * @return {[type]}    [description]
     */
    self.scrollTo = function(el) {
        $('html, body').animate({
            scrollTop: $(el).offset().top
        }, "slow");
    };

    /**
     * [function description]
     * @return {[type]} [description]
     */
    self.showMarkers = function() {
        ko.utils.arrayForEach(self.placeList(), function(place) {
            place.marker.setMap(googleMapObject.map);
        });

        self.hasMarkers = true;
    };
};

/**
 * [ViewModel description]
 */
var view = new ViewModel();

/**
 * [$ description]
 * @param  {[type]} document [description]
 * @return {[type]}          [description]
 */
$(document).ready(function() {
    view.init();
    ko.applyBindings(view);

    $(window).on('resize', function() {
        google.maps.event.trigger(googleMapObject.map, 'resize');
        googleMapObject.map.setCenter(googleMapObject.options.center);
    });
});
/**
 * [addDomListener description]
 * @param {[type]} window          [description]
 * @param {[type]} load            [description]
 * @param {[type]} googleMapObject [description]
 */
google.maps.event.addDomListener(window, 'load', googleMapObject.initMap(view));
